---
// 标签页组件
// 提供标签页切换功能

export interface Props {
  id?: string;
  defaultTab?: number;
  variant?: 'default' | 'pills' | 'underline';
  size?: 'sm' | 'md' | 'lg';
  vertical?: boolean;
}

const { 
  id = 'tabs-' + Math.random().toString(36).substring(2, 9),
  defaultTab = 0,
  variant = 'default',
  size = 'md',
  vertical = false
} = Astro.props;

// 根据变体设置样式
const tabListClasses = {
  default: `border-b border-border ${vertical ? 'border-b-0 border-r border-border flex-col' : ''}`,
  pills: `space-x-1 ${vertical ? 'space-x-0 space-y-1 flex-col' : ''}`,
  underline: `border-b-0 ${vertical ? 'flex-col' : ''}`
};

const tabClasses = {
  default: {
    base: `px-4 py-2 font-medium text-text-secondary border-b-2 border-transparent transition-colors duration-200 ${vertical ? 'border-b-0 border-r-2' : ''}`,
    active: `text-accent border-accent`,
    inactive: `hover:text-text-primary hover:border-border`
  },
  pills: {
    base: `px-4 py-2 font-medium text-text-secondary rounded-md transition-colors duration-200`,
    active: `bg-accent text-white`,
    inactive: `hover:bg-secondary hover:text-text-primary`
  },
  underline: {
    base: `px-4 py-2 font-medium text-text-secondary border-b-2 border-transparent transition-all duration-200 ${vertical ? 'border-b-0 border-r-2' : ''}`,
    active: `text-accent border-accent`,
    inactive: `hover:text-text-primary hover:border-border`
  }
};

// 根据大小设置样式
const sizeClasses = {
  sm: 'text-sm',
  md: 'text-base',
  lg: 'text-lg'
};
---

<div class="tabs-container" data-tabs-id={id} data-default-tab={defaultTab}>
  <div class={`tab-list flex ${vertical ? 'flex-col' : 'flex-row'} ${tabListClasses[variant]} ${sizeClasses[size]}`} role="tablist">
    <slot name="tabs" />
  </div>
  
  <div class="tab-panels mt-4" role="tabpanel">
    <slot name="panels" />
  </div>
</div>

<script>
  // 标签页逻辑
  document.addEventListener('DOMContentLoaded', () => {
    // 获取所有标签页容器
    const tabsContainers = document.querySelectorAll('.tabs-container');
    
    tabsContainers.forEach(container => {
      const tabsId = container.getAttribute('data-tabs-id');
      const defaultTab = parseInt(container.getAttribute('data-default-tab') || '0');
      
      // 获取所有标签和面板
      const tabs = container.querySelectorAll('[data-tab]');
      const panels = container.querySelectorAll('[data-panel]');
      
      if (!tabs.length || !panels.length) return;
      
      // 初始化标签页
      let activeTab = defaultTab;
      
      // 显示指定标签
      function showTab(index) {
        if (index < 0 || index >= tabs.length) return;
        
        // 更新标签状态
        tabs.forEach((tab, i) => {
          if (i === index) {
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
          } else {
            tab.classList.remove('active');
            tab.setAttribute('aria-selected', 'false');
          }
        });
        
        // 更新面板状态
        panels.forEach((panel, i) => {
          if (i === index) {
            panel.classList.remove('hidden');
            panel.setAttribute('aria-hidden', 'false');
          } else {
            panel.classList.add('hidden');
            panel.setAttribute('aria-hidden', 'true');
          }
        });
        
        // 更新活动标签
        activeTab = index;
        
        // 触发自定义事件
        const event = new CustomEvent('tabs:change', { 
          detail: { 
            id: tabsId,
            activeTab: index,
            tab: tabs[index],
            panel: panels[index]
          }
        });
        document.dispatchEvent(event);
      }
      
      // 为每个标签添加点击事件
      tabs.forEach((tab, index) => {
        tab.addEventListener('click', () => {
          showTab(index);
        });
      });
      
      // 初始化显示默认标签
      showTab(activeTab);
      
      // 添加键盘导航支持
      container.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          const newIndex = activeTab > 0 ? activeTab - 1 : tabs.length - 1;
          showTab(newIndex);
          tabs[newIndex].focus();
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          const newIndex = activeTab < tabs.length - 1 ? activeTab + 1 : 0;
          showTab(newIndex);
          tabs[newIndex].focus();
        } else if (e.key === 'Home') {
          e.preventDefault();
          showTab(0);
          tabs[0].focus();
        } else if (e.key === 'End') {
          e.preventDefault();
          showTab(tabs.length - 1);
          tabs[tabs.length - 1].focus();
        }
      });
      
      // 暴露全局方法
      window[`showTab_${tabsId}`] = showTab;
    });
  });
</script>