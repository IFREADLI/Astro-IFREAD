---
import { THEMES, getCurrentTheme, setTheme } from '../../utils/theme';

// 获取当前主题
const currentTheme = getCurrentTheme();
---

<div class="theme-toggle" id="theme-toggle">
  <button 
    class="theme-toggle-button"
    aria-label="切换主题"
    title="切换主题"
  >
    <div class="theme-icons">
      <!-- 浅色模式图标 -->
      <svg class="theme-icon theme-icon-light" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
      
      <!-- 深色模式图标 -->
      <svg class="theme-icon theme-icon-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
      
      <!-- 系统模式图标 -->
      <svg class="theme-icon theme-icon-system" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
    </div>
  </button>
  
  <!-- 主题选择器下拉菜单 -->
  <div class="theme-selector" id="theme-selector">
    <div class="theme-selector-header">选择主题</div>
    <div class="theme-options">
      {Object.entries(THEMES).map(([key, theme]) => (
        <button 
          class={`theme-option ${currentTheme === key ? 'active' : ''}`}
          data-theme={key}
          aria-label={theme.label}
        >
          <div class="theme-option-icon">
            {theme.icon === 'sun' && (
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
            )}
            {theme.icon === 'moon' && (
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
              </svg>
            )}
            {theme.icon === 'desktop' && (
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            )}
          </div>
          <div class="theme-option-label">{theme.label}</div>
          {currentTheme === key && (
            <div class="theme-option-check">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
          )}
        </button>
      ))}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const themeToggle = document.getElementById('theme-toggle');
    const themeSelector = document.getElementById('theme-selector');
    const themeOptions = document.querySelectorAll('.theme-option');
    
    // 切换主题选择器显示/隐藏
    themeToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      themeSelector.classList.toggle('show');
    });
    
    // 点击其他地方关闭主题选择器
    document.addEventListener('click', () => {
      themeSelector.classList.remove('show');
    });
    
    // 阻止主题选择器内部点击事件冒泡
    themeSelector.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
    // 处理主题选择
    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.getAttribute('data-theme');
        if (theme) {
          // 更新活动状态
          themeOptions.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          
          // 应用主题
          setTheme(theme);
          
          // 更新按钮图标
          updateThemeIcon(theme);
          
          // 关闭选择器
          themeSelector.classList.remove('show');
        }
      });
    });
    
    // 更新主题图标
    function updateThemeIcon(theme) {
      const icons = document.querySelectorAll('.theme-icon');
      icons.forEach(icon => icon.classList.remove('active'));
      
      if (theme === 'light') {
        document.querySelector('.theme-icon-light').classList.add('active');
      } else if (theme === 'dark') {
        document.querySelector('.theme-icon-dark').classList.add('active');
      } else {
        document.querySelector('.theme-icon-system').classList.add('active');
      }
    }
    
    // 初始化主题图标
    updateThemeIcon('{currentTheme}');
    
    // 监听主题变化事件
    window.addEventListener('themechange', (e) => {
      updateThemeIcon(e.detail.theme);
    });
  });
</script>

<!-- Style removed for troubleshooting -->