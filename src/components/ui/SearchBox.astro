---
// 搜索框组件
// 提供搜索功能和自动完成

export interface Props {
  id?: string;
  placeholder?: string;
  value?: string;
  size?: 'sm' | 'md' | 'lg';
  variant?: 'default' | 'filled' | 'outlined';
  icon?: 'search' | 'filter' | 'none';
  clearable?: boolean;
  loading?: boolean;
  disabled?: boolean;
  suggestions?: string[];
  maxSuggestions?: number;
}

const { 
  id = 'search-' + Math.random().toString(36).substring(2, 9),
  placeholder = '搜索...',
  value = '',
  size = 'md',
  variant = 'default',
  icon = 'search',
  clearable = true,
  loading = false,
  disabled = false,
  suggestions = [],
  maxSuggestions = 5
} = Astro.props;

// 根据大小设置样式
const sizeClasses = {
  sm: 'py-1 px-2 text-sm',
  md: 'py-2 px-3 text-base',
  lg: 'py-3 px-4 text-lg'
};

// 根据变体设置样式
const variantClasses = {
  default: 'bg-primary dark:bg-secondary border border-border focus:border-accent focus:ring-2 focus:ring-accent/20',
  filled: 'bg-secondary dark:bg-tertiary border-0 focus:ring-2 focus:ring-accent/20',
  outlined: 'bg-transparent border-2 border-border focus:border-accent focus:ring-0'
};
---

<div class="search-container relative w-full" data-search-id={id}>
  <div class="relative">
    {icon === 'search' && (
      <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-text-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
        </svg>
      </div>
    )}
    
    {icon === 'filter' && (
      <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-text-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
        </svg>
      </div>
    )}
    
    <input
      id={id}
      type="text"
      placeholder={placeholder}
      value={value}
      disabled={disabled}
      class={`w-full ${icon !== 'none' ? 'pl-10' : 'pl-3'} ${clearable || loading ? 'pr-10' : 'pr-3'} ${sizeClasses[size]} ${variantClasses[variant]} rounded-md transition-colors duration-200 outline-none`}
      autocomplete="off"
    />
    
    {loading && (
      <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-accent">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    )}
    
    {clearable && !loading && value && (
      <button 
        type="button"
        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary hover:text-text-primary transition-colors duration-200"
        aria-label="清除搜索"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
      </button>
    )}
  </div>
  
  {suggestions.length > 0 && (
    <div class="suggestions absolute top-full left-0 right-0 mt-1 bg-primary dark:bg-secondary border border-border rounded-md shadow-lg z-10 hidden">
      <ul class="py-1">
        {suggestions.slice(0, maxSuggestions).map((suggestion, index) => (
          <li 
            key={index}
            class="px-3 py-2 hover:bg-secondary dark:hover:bg-tertiary cursor-pointer transition-colors duration-200"
            data-suggestion={suggestion}
          >
            {suggestion}
          </li>
        ))}
      </ul>
    </div>
  )}
</div>

<script>
  // 搜索框逻辑
  document.addEventListener('DOMContentLoaded', () => {
    // 获取所有搜索容器
    const searchContainers = document.querySelectorAll('.search-container');
    
    searchContainers.forEach(container => {
      const searchId = container.getAttribute('data-search-id');
      const input = container.querySelector('input');
      const clearButton = container.querySelector('button');
      const suggestionsContainer = container.querySelector('.suggestions');
      
      if (!input) return;
      
      // 显示/隐藏建议
      function showSuggestions() {
        if (suggestionsContainer && suggestionsContainer.children.length > 0) {
          suggestionsContainer.classList.remove('hidden');
        }
      }
      
      function hideSuggestions() {
        if (suggestionsContainer) {
          suggestionsContainer.classList.add('hidden');
        }
      }
      
      // 清除输入
      function clearInput() {
        input.value = '';
        hideSuggestions();
        
        // 触发清除事件
        const event = new CustomEvent('search:clear', { 
          detail: { 
            id: searchId,
            input
          }
        });
        document.dispatchEvent(event);
      }
      
      // 输入事件
      input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // 触发搜索事件
        const searchEvent = new CustomEvent('search:input', { 
          detail: { 
            id: searchId,
            value,
            input
          }
        });
        document.dispatchEvent(searchEvent);
        
        // 如果有值，显示建议
        if (value && suggestionsContainer) {
          // 过滤建议
          const suggestions = Array.from(suggestionsContainer.querySelectorAll('[data-suggestion]'));
          const filteredSuggestions = suggestions.filter(suggestion => 
            suggestion.textContent.toLowerCase().includes(value.toLowerCase())
          );
          
          // 显示/隐藏建议项
          suggestions.forEach(suggestion => {
            suggestion.style.display = filteredSuggestions.includes(suggestion) ? 'block' : 'none';
          });
          
          // 如果有匹配的建议，显示建议容器
          if (filteredSuggestions.length > 0) {
            showSuggestions();
          } else {
            hideSuggestions();
          }
        } else {
          hideSuggestions();
        }
      });
      
      // 焦点事件
      input.addEventListener('focus', () => {
        if (input.value && suggestionsContainer) {
          showSuggestions();
        }
      });
      
      // 点击清除按钮
      if (clearButton) {
        clearButton.addEventListener('click', clearInput);
      }
      
      // 建议项点击事件
      if (suggestionsContainer) {
        const suggestionItems = suggestionsContainer.querySelectorAll('[data-suggestion]');
        
        suggestionItems.forEach(item => {
          item.addEventListener('click', () => {
            const suggestion = item.getAttribute('data-suggestion');
            input.value = suggestion;
            hideSuggestions();
            
            // 触发选择建议事件
            const event = new CustomEvent('search:suggestion-select', { 
              detail: { 
                id: searchId,
                suggestion,
                input
              }
            });
            document.dispatchEvent(event);
            
            // 触发搜索事件
            const searchEvent = new CustomEvent('search:submit', { 
              detail: { 
                id: searchId,
                value: suggestion,
                input
              }
            });
            document.dispatchEvent(searchEvent);
          });
        });
      }
      
      // 键盘事件
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          hideSuggestions();
          
          // 触发搜索事件
          const event = new CustomEvent('search:submit', { 
            detail: { 
              id: searchId,
              value: input.value,
              input
            }
          });
          document.dispatchEvent(event);
        } else if (e.key === 'Escape') {
          hideSuggestions();
        } else if (e.key === 'ArrowDown' && suggestionsContainer && !suggestionsContainer.classList.contains('hidden')) {
          e.preventDefault();
          // 实现键盘导航建议项
          const visibleSuggestions = Array.from(suggestionsContainer.querySelectorAll('[data-suggestion]'))
            .filter(item => item.style.display !== 'none');
          
          const focusedItem = suggestionsContainer.querySelector('.focus');
          
          if (focusedItem) {
            const currentIndex = visibleSuggestions.indexOf(focusedItem);
            const nextIndex = (currentIndex + 1) % visibleSuggestions.length;
            
            focusedItem.classList.remove('focus', 'bg-secondary', 'dark:bg-tertiary');
            visibleSuggestions[nextIndex].classList.add('focus', 'bg-secondary', 'dark:bg-tertiary');
          } else if (visibleSuggestions.length > 0) {
            visibleSuggestions[0].classList.add('focus', 'bg-secondary', 'dark:bg-tertiary');
          }
        } else if (e.key === 'ArrowUp' && suggestionsContainer && !suggestionsContainer.classList.contains('hidden')) {
          e.preventDefault();
          // 实现键盘导航建议项
          const visibleSuggestions = Array.from(suggestionsContainer.querySelectorAll('[data-suggestion]'))
            .filter(item => item.style.display !== 'none');
          
          const focusedItem = suggestionsContainer.querySelector('.focus');
          
          if (focusedItem) {
            const currentIndex = visibleSuggestions.indexOf(focusedItem);
            const prevIndex = currentIndex === 0 ? visibleSuggestions.length - 1 : currentIndex - 1;
            
            focusedItem.classList.remove('focus', 'bg-secondary', 'dark:bg-tertiary');
            visibleSuggestions[prevIndex].classList.add('focus', 'bg-secondary', 'dark:bg-tertiary');
          } else if (visibleSuggestions.length > 0) {
            visibleSuggestions[visibleSuggestions.length - 1].classList.add('focus', 'bg-secondary', 'dark:bg-tertiary');
          }
        }
      });
      
      // 点击文档其他地方隐藏建议
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          hideSuggestions();
        }
      });
    });
  });
</script>