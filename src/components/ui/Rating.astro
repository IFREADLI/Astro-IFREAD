---
// 评分组件
// 提供星级评分功能

export interface Props {
  id?: string;
  value?: number;
  max?: number;
  size?: 'sm' | 'md' | 'lg';
  color?: 'primary' | 'secondary' | 'accent' | 'warning' | 'success';
  readonly?: boolean;
  showValue?: boolean;
  allowHalf?: boolean;
  icon?: 'star' | 'heart' | 'thumb';
}

const { 
  id = 'rating-' + Math.random().toString(36).substring(2, 9),
  value = 0,
  max = 5,
  size = 'md',
  color = 'accent',
  readonly = false,
  showValue = true,
  allowHalf = false,
  icon = 'star'
} = Astro.props;

// 根据大小设置样式
const sizeClasses = {
  sm: 'w-4 h-4',
  md: 'w-5 h-5',
  lg: 'w-6 h-6'
};

// 根据颜色设置样式
const colorClasses = {
  primary: 'text-primary',
  secondary: 'text-secondary',
  accent: 'text-accent',
  warning: 'text-yellow-500',
  success: 'text-green-500'
};

// 根据图标类型设置SVG路径
const iconPaths = {
  star: {
    filled: '<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />',
    half: '<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />',
    empty: '<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />'
  },
  heart: {
    filled: '<path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />',
    half: '<path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />',
    empty: '<path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />'
  },
  thumb: {
    filled: '<path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />',
    half: '<path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />',
    empty: '<path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />'
  }
};
---

<div class="rating-container flex items-center gap-1" data-rating-id={id} data-readonly={readonly} data-allow-half={allowHalf}>
  <div class="rating-stars flex items-center">
    {Array.from({ length: max }, (_, i) => {
      const starValue = i + 1;
      const isFilled = starValue <= value;
      const isHalf = allowHalf && starValue - 0.5 === value;
      
      return (
        <div 
          key={i} 
          class="relative"
          data-star-value={starValue}
        >
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            viewBox="0 0 20 20" 
            fill="currentColor" 
            class={`${sizeClasses[size]} ${colorClasses[color]} ${!readonly ? 'cursor-pointer' : ''} transition-colors duration-200`}
          >
            {isFilled ? iconPaths[icon].filled : iconPaths[icon].empty}
          </svg>
          
          {allowHalf && (
            <div class="absolute inset-0 overflow-hidden" style={{ width: '50%' }}>
              <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 20 20" 
                fill="currentColor" 
                class={`${sizeClasses[size]} ${colorClasses[color]} ${!readonly ? 'cursor-pointer' : ''} transition-colors duration-200`}
                style={{ marginLeft: '-100%' }}
              >
                {isHalf ? iconPaths[icon].half : ''}
              </svg>
            </div>
          )}
        </div>
      );
    })}
  </div>
  
  {showValue && (
    <span class="ml-2 text-text-primary">
      {allowHalf ? value.toFixed(1) : value}/{max}
    </span>
  )}
</div>

<script>
  // 评分逻辑
  document.addEventListener('DOMContentLoaded', () => {
    // 获取所有评分容器
    const ratingContainers = document.querySelectorAll('.rating-container');
    
    ratingContainers.forEach(container => {
      const ratingId = container.getAttribute('data-rating-id');
      const isReadonly = container.getAttribute('data-readonly') === 'true';
      const allowHalf = container.getAttribute('data-allow-half') === 'true';
      const stars = container.querySelectorAll('[data-star-value]');
      
      if (isReadonly) return;
      
      let currentValue = 0;
      let hoverValue = 0;
      
      // 更新星星显示
      function updateStars(value) {
        stars.forEach((star, index) => {
          const starValue = parseInt(star.getAttribute('data-star-value'));
          const isFilled = starValue <= value;
          const isHalf = allowHalf && starValue - 0.5 === value;
          
          const svg = star.querySelector('svg');
          const halfContainer = star.querySelector('.absolute');
          const halfSvg = halfContainer?.querySelector('svg');
          
          if (isFilled) {
            svg.innerHTML = getFilledIconPath();
            if (halfSvg) {
              halfSvg.innerHTML = '';
            }
          } else if (isHalf) {
            svg.innerHTML = getEmptyIconPath();
            if (halfSvg) {
              halfSvg.innerHTML = getFilledIconPath();
            }
          } else {
            svg.innerHTML = getEmptyIconPath();
            if (halfSvg) {
              halfSvg.innerHTML = '';
            }
          }
        });
        
        // 更新显示值
        const valueDisplay = container.querySelector('span');
        if (valueDisplay) {
          valueDisplay.textContent = allowHalf ? value.toFixed(1) : Math.round(value);
        }
      }
      
      // 获取填充图标路径
      function getFilledIconPath() {
        const iconType = container.getAttribute('data-icon') || 'star';
        const iconPaths = {
          star: '<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />',
          heart: '<path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />',
          thumb: '<path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />'
        };
        return iconPaths[iconType] || iconPaths.star;
      }
      
      // 获取空图标路径
      function getEmptyIconPath() {
        const iconType = container.getAttribute('data-icon') || 'star';
        const iconPaths = {
          star: '<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />',
          heart: '<path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />',
          thumb: '<path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />'
        };
        return iconPaths[iconType] || iconPaths.star;
      }
      
      // 鼠标进入星星
      function handleMouseEnter(star, e) {
        const starValue = parseInt(star.getAttribute('data-star-value'));
        
        if (allowHalf && e.offsetX < star.offsetWidth / 2) {
          hoverValue = starValue - 0.5;
        } else {
          hoverValue = starValue;
        }
        
        updateStars(hoverValue);
      }
      
      // 鼠标离开容器
      function handleMouseLeave() {
        updateStars(currentValue);
      }
      
      // 点击星星
      function handleClick(star, e) {
        const starValue = parseInt(star.getAttribute('data-star-value'));
        
        if (allowHalf && e.offsetX < star.offsetWidth / 2) {
          currentValue = starValue - 0.5;
        } else {
          currentValue = starValue;
        }
        
        updateStars(currentValue);
        
        // 触发评分变化事件
        const event = new CustomEvent('rating:change', { 
          detail: { 
            id: ratingId,
            value: currentValue
          }
        });
        document.dispatchEvent(event);
      }
      
      // 为每个星星添加事件监听
      stars.forEach(star => {
        star.addEventListener('mouseenter', (e) => handleMouseEnter(star, e));
        star.addEventListener('click', (e) => handleClick(star, e));
      });
      
      // 容器鼠标离开事件
      container.addEventListener('mouseleave', handleMouseLeave);
      
      // 初始化当前值
      const initialValue = parseFloat(container.getAttribute('data-value') || '0');
      currentValue = initialValue;
      updateStars(currentValue);
      
      // 暴露全局方法
      window[`setRating_${ratingId}`] = (value) => {
        currentValue = value;
        updateStars(currentValue);
        
        const event = new CustomEvent('rating:change', { 
          detail: { 
            id: ratingId,
            value: currentValue
          }
        });
        document.dispatchEvent(event);
      };
      
      window[`getRating_${ratingId}`] = () => currentValue;
    });
  });
</script>