---
interface Props {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  type?: string;
  keywords?: string[];
  author?: string;
  publishedTime?: string;
  modifiedTime?: string;
  articleSection?: string;
  tags?: string[];
  noIndex?: boolean;
  structuredData?: Record<string, any>;
}

const {
  title,
  description,
  image,
  url,
  type = 'website',
  keywords,
  author,
  publishedTime,
  modifiedTime,
  articleSection,
  tags,
  noIndex = false,
  structuredData = {}
} = Astro.props;

import { SITE } from '../../utils/config';

// 获取完整的页面标题
const pageTitle = title ? `${title} | ${SITE.title}` : SITE.title;

// 获取页面描述
const pageDescription = description || SITE.description;

// 获取页面URL
const pageUrl = url ? `${SITE.url}${url}` : SITE.url;

// 获取页面图片
const pageImage = image ? `${SITE.url}${image}` : `${SITE.url}${SITE.image}`;

// 生成关键词
const pageKeywords = keywords ? keywords.join(', ') : '';

// 生成结构化数据
const generateStructuredData = () => {
  const baseData = {
    '@context': 'https://schema.org',
    '@type': type,
    headline: title || SITE.title,
    description: pageDescription,
    url: pageUrl,
    image: pageImage,
    publisher: SITE.seo.structuredData.publisher,
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': pageUrl
    }
  };

  // 如果是文章类型，添加文章特定的字段
  if (type === 'BlogPosting' || type === 'Article') {
    baseData.datePublished = publishedTime;
    baseData.dateModified = modifiedTime || publishedTime;
    baseData.author = SITE.seo.structuredData.author;
    
    if (articleSection) {
      baseData.articleSection = articleSection;
    }
    
    if (tags && tags.length > 0) {
      baseData.keywords = tags.join(', ');
    }
  }

  // 合并自定义结构化数据
  return { ...baseData, ...structuredData };
};
---

<!-- 基础元标签 -->
<title>{pageTitle}</title>
<meta name="description" content={pageDescription} />
{pageKeywords && <meta name="keywords" content={pageKeywords} />}
{author && <meta name="author" content={author} />}

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={pageUrl} />
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:image" content={pageImage} />
<meta property="og:locale" content={SITE.locale} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={pageUrl} />
<meta property="twitter:title" content={pageTitle} />
<meta property="twitter:description" content={pageDescription} />
<meta property="twitter:image" content={pageImage} />

<!-- SEO控制 -->
{noIndex && <meta name="robots" content="noindex, nofollow" />}
{!noIndex && <meta name="robots" content="index, follow" />}

<!-- 文章特定的元标签 -->
{publishedTime && <meta property="article:published_time" content={publishedTime} />}
{modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
{articleSection && <meta property="article:section" content={articleSection} />}
{tags && tags.map(tag => <meta property="article:tag" content={tag} />)}

<!-- 结构化数据 -->
{SITE.seo.structuredData.enable && (
  <script type="application/ld+json" set:html={JSON.stringify(generateStructuredData())} />
)}

<!-- 预加载关键资源 -->
<link rel="preload" href="/fonts/inter-var.woff2" as="font" type="font/woff2" crossorigin />

<!-- DNS预解析 -->
<link rel="dns-prefetch" href="//fonts.googleapis.com" />
<link rel="dns-prefetch" href="//www.google-analytics.com" />

<!-- 预连接 -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
<link rel="preconnect" href="https://www.google-analytics.com" crossorigin />