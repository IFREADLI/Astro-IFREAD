---
interface Props {
  initialQuery?: string;
  placeholder?: string;
  showSuggestions?: boolean;
}

const { 
  initialQuery = '', 
  placeholder = '搜索文章...', 
  showSuggestions = true 
} = Astro.props;
---

<div class="search-box" id="search-box">
  <div class="relative">
    <input
      type="text"
      id="search-input"
      class="search-input w-full px-4 py-3 pr-10 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
      placeholder={placeholder}
      value={initialQuery}
      autocomplete="off"
    />
    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
  </div>
  
  {showSuggestions && (
    <div id="search-suggestions" class="search-suggestions absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg hidden">
      <!-- 搜索建议将通过JavaScript动态插入 -->
    </div>
  )}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const suggestionsContainer = document.getElementById('search-suggestions');
    let currentFocus = -1;
    
    async function getSuggestions(query) {
      if (!query.trim()) return [];
      
      try {
        const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=5`);
        if (!response.ok) {
          throw new Error('Failed to fetch suggestions');
        }
        
        const data = await response.json();
        return data.suggestions || [];
      } catch (error) {
        console.error('Error fetching search suggestions:', error);
        return [];
      }
    }
    
    function showSuggestions(suggestions) {
      if (!suggestionsContainer) return;
      
      suggestionsContainer.innerHTML = '';
      currentFocus = -1;
      
      if (suggestions.length === 0) {
        suggestionsContainer.classList.add('hidden');
        return;
      }
      
      suggestions.forEach((suggestion, index) => {
        const item = document.createElement('div');
        item.className = 'search-suggestion-item px-4 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700';
        item.textContent = suggestion;
        item.addEventListener('click', () => {
          searchInput.value = suggestion;
          submitSearch();
        });
        
        item.addEventListener('mouseenter', () => {
          currentFocus = index;
          updateActiveSuggestion();
        });
        
        suggestionsContainer.appendChild(item);
      });
      
      suggestionsContainer.classList.remove('hidden');
    }
    
    function updateActiveSuggestion() {
      if (!suggestionsContainer) return;
      const items = suggestionsContainer.getElementsByClassName('search-suggestion-item');
      if (!items) return;
      
      Array.from(items).forEach(item => {
        item.classList.remove('bg-gray-100', 'dark:bg-gray-700');
      });
      
      if (currentFocus >= 0 && currentFocus < items.length) {
        items[currentFocus].classList.add('bg-gray-100', 'dark:bg-gray-700');
      }
    }
    
    function submitSearch() {
      const query = searchInput.value.trim();
      if (query) {
        const url = new URL(window.location.href);
        url.pathname = '/search';
        url.searchParams.set('q', query);
        window.location.href = url.toString();
      }
    }
    
    searchInput.addEventListener('input', async () => {
      const query = searchInput.value.trim();
      
      if (query.length < 2) {
        showSuggestions([]);
        return;
      }
      
      const suggestions = await getSuggestions(query);
      showSuggestions(suggestions);
    });
    
    searchInput.addEventListener('keydown', (e) => {
      if (!suggestionsContainer) return;
      const items = suggestionsContainer.getElementsByClassName('search-suggestion-item');
      if (!items) return;
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentFocus++;
        if (currentFocus >= items.length) currentFocus = 0;
        updateActiveSuggestion();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentFocus--;
        if (currentFocus < 0) currentFocus = items.length - 1;
        updateActiveSuggestion();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentFocus > -1 && items[currentFocus]) {
          items[currentFocus].click();
        } else {
          submitSearch();
        }
      } else if (e.key === 'Escape') {
        showSuggestions([]);
      }
    });
    
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        showSuggestions([]);
      }
    });
  });
</script>

<style>
  .search-box {
    position: relative;
    width: 100%;
    max-width: 500px;
  }
  .search-input {
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  .search-input:focus {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
  }
  .search-suggestions {
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
  }
  .search-suggestion-item {
    transition: background-color 0.2s ease;
  }
  .search-suggestion-item:hover,
  .search-suggestion-item:focus {
    background-color: #f3f4f6;
  }
  :global(.dark) .search-input:focus {
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
  }
  :global(.dark) .search-suggestion-item:hover,
  :global(.dark) .search-suggestion-item:focus {
    background-color: #374151;
  }
  @media (max-width: 640px) {
    .search-box {
      max-width: 100%;
    }
  }
</style>