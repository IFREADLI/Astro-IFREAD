---
interface Props {
  categories: string[];
  allTags: string[];
  initialCategory?: string;
  initialTags?: string[];
  initialSortBy?: 'relevance' | 'date' | 'title';
  initialSortOrder?: 'asc' | 'desc';
}

const { 
  categories, 
  allTags, 
  initialCategory = '', 
  initialTags = [], 
  initialSortBy = 'relevance',
  initialSortOrder = 'desc'
} = Astro.props;
---

<div class="search-filters">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
    <h2 class="text-lg font-semibold mb-4">筛选器</h2>
    
    <!-- 分类过滤器 -->
    <div class="mb-6">
      <h3 class="text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">分类</h3>
      <select 
        id="category-filter" 
        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-accent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
      >
        <option value="">所有分类</option>
        {categories.map(category => (
          <option value={category} selected={initialCategory === category}>
            {category}
          </option>
        ))}
      </select>
    </div>
    
    <!-- 标签过滤器 -->
    <div class="mb-6">
      <h3 class="text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">标签</h3>
      <div class="space-y-2 max-h-48 overflow-y-auto">
        {allTags.map(tag => (
          <label class="flex items-center">
            <input 
              type="checkbox" 
              value={tag} 
              class="mr-2 rounded text-accent focus:ring-accent"
              checked={initialTags.includes(tag)}
            />
            <span class="text-sm text-gray-700 dark:text-gray-300">{tag}</span>
          </label>
        ))}
      </div>
    </div>
    
    <!-- 排序选项 -->
    <div class="mb-6">
      <h3 class="text-sm font-medium mb-2 text-gray-700 dark:text-gray-300">排序</h3>
      <div class="space-y-3">
        <div>
          <label class="text-xs text-gray-600 dark:text-gray-400">排序方式</label>
          <select 
            id="sort-by" 
            class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-accent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
          >
            <option value="relevance" selected={initialSortBy === 'relevance'}>相关性</option>
            <option value="date" selected={initialSortBy === 'date'}>发布日期</option>
            <option value="title" selected={initialSortBy === 'title'}>标题</option>
          </select>
        </div>
        
        <div>
          <label class="text-xs text-gray-600 dark:text-gray-400">排序顺序</label>
          <select 
            id="sort-order" 
            class="w-full mt-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-accent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
          >
            <option value="desc" selected={initialSortOrder === 'desc'}>降序</option>
            <option value="asc" selected={initialSortOrder === 'asc'}>升序</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- 应用过滤器按钮 -->
    <button 
      id="apply-filters" 
      class="w-full bg-accent text-white py-2 px-4 rounded-md hover:bg-accent/90 transition-colors"
    >
      应用过滤器
    </button>
    
    <!-- 重置过滤器按钮 -->
    <button 
      id="reset-filters" 
      class="w-full mt-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
    >
      重置过滤器
    </button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categoryFilter = document.getElementById('category-filter') as HTMLSelectElement;
    const tagCheckboxes = document.querySelectorAll('input[type="checkbox"][value]');
    const sortBySelect = document.getElementById('sort-by') as HTMLSelectElement;
    const sortOrderSelect = document.getElementById('sort-order') as HTMLSelectElement;
    const applyFiltersBtn = document.getElementById('apply-filters');
    const resetFiltersBtn = document.getElementById('reset-filters');
    
    // 应用过滤器
    function applyFilters() {
      const url = new URL(window.location.href);
      const query = url.searchParams.get('q') || '';
      
      // 获取选中的分类
      const category = categoryFilter.value;
      
      // 获取选中的标签
      const selectedTags: string[] = [];
      tagCheckboxes.forEach(checkbox => {
        if ((checkbox as HTMLInputElement).checked) {
          selectedTags.push(checkbox.getAttribute('value') || '');
        }
      });
      
      // 获取排序选项
      const sortBy = sortBySelect.value;
      const sortOrder = sortOrderSelect.value;
      
      // 构建新的URL
      const newUrl = new URL('/search', window.location.origin);
      newUrl.searchParams.set('q', query);
      
      if (category) {
        newUrl.searchParams.set('category', category);
      }
      
      if (selectedTags.length > 0) {
        newUrl.searchParams.set('tags', selectedTags.join(','));
      }
      
      newUrl.searchParams.set('sort', sortBy);
      newUrl.searchParams.set('order', sortOrder);
      
      // 跳转到新的URL
      window.location.href = newUrl.toString();
    }
    
    // 重置过滤器
    function resetFilters() {
      const url = new URL(window.location.href);
      const query = url.searchParams.get('q') || '';
      
      // 构建新的URL，只保留查询参数
      const newUrl = new URL('/search', window.location.origin);
      if (query) {
        newUrl.searchParams.set('q', query);
      }
      
      // 跳转到新的URL
      window.location.href = newUrl.toString();
    }
    
    // 绑定事件
    applyFiltersBtn?.addEventListener('click', applyFilters);
    resetFiltersBtn?.addEventListener('click', resetFilters);
    
    // 当选择变化时自动应用过滤器
    categoryFilter?.addEventListener('change', applyFilters);
    sortBySelect?.addEventListener('change', applyFilters);
    sortOrderSelect?.addEventListener('change', applyFilters);
    
    // 标签复选框变化时也自动应用
    tagCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', applyFilters);
    });
  });
</script>