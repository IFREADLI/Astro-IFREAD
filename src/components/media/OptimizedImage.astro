---
interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'sync' | 'auto';
  priority?: boolean;
  caption?: string;
  sizes?: string;
  srcset?: string;
  format?: 'webp' | 'avif' | 'png' | 'jpg';
  quality?: number;
}

const { 
  src, 
  alt, 
  width, 
  height, 
  class: className = '', 
  loading = 'lazy',
  decoding = 'async',
  priority = false,
  caption,
  sizes,
  srcset,
  format = 'webp',
  quality = 80
} = Astro.props;

// 如果是优先加载的图片，设置loading为eager
const finalLoading = priority ? 'eager' : loading;

// 生成不同尺寸的图片
const generateSrcSet = (baseSrc: string, format: string) => {
  const widths = [320, 640, 768, 1024, 1280, 1536];
  return widths
    .map(w => `${baseSrc}?w=${w}&f=${format}&q=${quality} ${w}w`)
    .join(', ');
};

// 生成默认的sizes属性
const defaultSizes = '(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw';

// 检查是否为外部图片
const isExternal = (src: string) => {
  return src.startsWith('http') || src.startsWith('//');
};

// 如果是外部图片，直接使用原始src
const imageSrc = isExternal(src) ? src : src;
const imageSrcset = isExternal(src) ? undefined : (srcset || generateSrcSet(src, format));
const imageSizes = sizes || defaultSizes;
---

<figure class="image-container {className}">
  <img
    src={imageSrc}
    srcset={imageSrcset}
    sizes={imageSizes}
    alt={alt}
    width={width}
    height={height}
    loading={finalLoading}
    decoding={decoding}
    class="w-full h-auto rounded-lg shadow-md"
  />
  {caption && (
    <figcaption class="mt-2 text-center text-sm text-secondary">
      {caption}
    </figcaption>
  )}
</figure>

<style>
  .image-container {
    margin: 1.5rem 0;
  }
  
  .image-container img {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .image-container:hover img {
    transform: scale(1.02);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  
  /* 图片加载状态 */
  .image-container img {
    opacity: 0;
    animation: fadeIn 0.5s ease forwards;
  }
  
  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }
  
  /* 响应式图片 */
  @media (max-width: 768px) {
    .image-container {
      margin: 1rem 0;
    }
  }
</style>