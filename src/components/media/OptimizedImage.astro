---
interface Props {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'sync' | 'auto';
  priority?: boolean;
  caption?: string;
  sizes?: string;
  srcset?: string;
  format?: 'webp' | 'avif' | 'png' | 'jpg';
  quality?: number;
}

const { 
  src, 
  alt, 
  width, 
  height, 
  class: className = '', 
  loading = 'lazy',
  decoding = 'async',
  priority = false,
  caption,
  sizes,
  srcset,
  format = 'webp',
  quality = 80
} = Astro.props;

// 如果是优先加载的图片，设置loading为eager
const finalLoading = priority ? 'eager' : loading;

// 生成不同尺寸的图片
const generateSrcSet = (baseSrc: string, format: string) => {
  const widths = [320, 640, 768, 1024, 1280, 1536];
  return widths
    .map(w => `${baseSrc}?w=${w}&f=${format}&q=${quality} ${w}w`)
    .join(', ');
};

// 生成默认的sizes属性
const defaultSizes = '(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw';

// 检查是否为外部图片
const isExternal = (src: string) => {
  return src.startsWith('http') || src.startsWith('//');
};

// 如果是外部图片，直接使用原始src
const imageSrc = isExternal(src) ? src : src;
const imageSrcset = isExternal(src) ? undefined : (srcset || generateSrcSet(src, format));
const imageSizes = sizes || defaultSizes;
---

<figure class="image-container {className}">
  <img
    src={imageSrc}
    srcset={imageSrcset}
    sizes={imageSizes}
    alt={alt}
    width={width}
    height={height}
    loading={finalLoading}
    decoding={decoding}
    class="w-full h-auto rounded-lg shadow-md"
  />
  {caption && (
    <figcaption class="mt-2 text-center text-sm text-secondary">
      {caption}
    </figcaption>
  )}
</figure>

<style>
  .image-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .image-container img {
    display: block;
    max-width: 100%;
    height: auto;
    transition: box-shadow 0.3s ease;
  }

  .image-container img:hover {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  figcaption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  @media (prefers-color-scheme: dark) {
    figcaption {
      color: #9ca3af;
    }
  }

  /* 响应式调整 */
  @media (max-width: 640px) {
    figcaption {
      font-size: 0.75rem;
    }
  }
</style>