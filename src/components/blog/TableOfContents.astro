---
interface Props {
  headings: Array<{
    depth: number;
    text: string;
    slug: string;
  }>;
}

const { headings } = Astro.props;

// 过滤掉太深的标题（只显示h2和h3）
const filteredHeadings = headings.filter(heading => heading.depth <= 3);
---

<!-- 文章目录 -->
<aside class="sticky top-20 self-start">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-4 w-64 max-h-[calc(100vh-6rem)] overflow-y-auto">
    <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3 flex items-center">
      <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
      目录
    </h3>
    
    {filteredHeadings.length > 0 ? (
      <ul class="space-y-2 text-sm">
        {filteredHeadings.map((heading) => (
          <li
            class={`toc-item ${
              heading.depth === 2 ? 'ml-0' : 'ml-4'
            }`}
          >
            <a
              href={`#${heading.slug}`}
              class="toc-link text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors block py-1"
              data-depth={heading.depth}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-sm text-gray-500 dark:text-gray-400">
        本文没有目录
      </p>
    )}
  </div>
</aside>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 获取所有目录链接
    const tocLinks = document.querySelectorAll('.toc-link');
    
    // 监听滚动事件，高亮当前章节
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const tocLink = document.querySelector(`.toc-link[href="#${id}"]`);
          
          if (tocLink) {
            if (entry.isIntersecting) {
              // 移除所有活动状态
              document.querySelectorAll('.toc-link').forEach(link => {
                link.classList.remove('text-primary-600', 'dark:text-primary-400', 'font-medium');
                link.classList.add('text-gray-600', 'dark:text-gray-400');
              });
              
              // 添加当前活动状态
              tocLink.classList.remove('text-gray-600', 'dark:text-gray-400');
              tocLink.classList.add('text-primary-600', 'dark:text-primary-400', 'font-medium');
            }
          }
        });
      },
      {
        rootMargin: '-20% 0px -70% 0px',
      }
    );
    
    // 观察所有标题
    document.querySelectorAll('h2[id], h3[id]').forEach((heading) => {
      observer.observe(heading);
    });
    
    // 平滑滚动到目标位置
    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const id = link.getAttribute('href').substring(1);
        const targetElement = document.getElementById(id);
        
        if (targetElement) {
          // 计算目标位置，考虑固定头部高度
          const headerHeight = document.querySelector('header')?.offsetHeight || 0;
          const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;
          
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
          
          // 更新URL但不触发滚动
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  });
</script>