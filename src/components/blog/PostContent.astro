---
import { getCollection } from 'astro:content';
import { formatReadingTime } from '../../utils/content';
import { formatDate } from '../../utils/content';
import { processMedia } from '../../utils/media';
import type { CollectionEntry } from 'astro:content';
import OptimizedImage from '../media/OptimizedImage.astro';
import CodeBlock from '../media/CodeBlock.astro';
import VideoPlayer from '../media/VideoPlayer.astro';
import AudioPlayer from '../media/AudioPlayer.astro';
import Gallery from '../media/Gallery.astro';
import ReadingMode from '../ui/ReadingMode.astro';
import FontSizeAdjuster from '../ui/FontSizeAdjuster.astro';
import Bookmark from '../ui/Bookmark.astro';
import Comments from '../ui/Comments.astro';

interface Props {
  post: CollectionEntry<'blog'>;
  prev?: CollectionEntry<'blog'>;
  next?: CollectionEntry<'blog'>;
  readingTime?: number;
}

const { post, prev, next, readingTime } = Astro.props;

const { title, description, pubDate, updatedDate, category, tags, featuredImage } = post.data;

const { Content, html } = await post.render();

// 处理媒体元素
const processedHtml = processMedia(html);

// 获取分类配置
const categoriesCollection = await getCollection('categories');
const categoriesConfig = categoriesCollection.reduce((acc, cat) => {
  acc[cat.id] = cat.data;
  return acc;
}, {});
const categoryData = category ? categoriesConfig[category] : null;

const formattedDate = formatDate(pubDate);
const formattedReadingTime = formatReadingTime(readingTime);
---

<!-- 文章头部 -->
<header class="mb-8">
  <!-- 封面图片 -->
  {featuredImage && (
    <div class="mb-6">
      <OptimizedImage 
        src={featuredImage.src} 
        alt={featuredImage.alt || title}
        class="aspect-video"
        priority={true}
      />
    </div>
  )}
  
  <!-- 标题 -->
  <h1 class="text-3xl md:text-4xl font-bold mb-4 text-gray-900 dark:text-white">
    {title}
  </h1>
  
  <!-- 文章元信息 -->
  <div class="flex flex-wrap items-center gap-4 text-sm text-gray-600 dark:text-gray-400 mb-4">
    {category && categoryData && (
      <a href={`/categories/${category}/`} class="hover:text-primary-600 dark:hover:text-primary-400 transition-colors">
        <span class="inline-flex items-center">
          {categoryData.icon && (
            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              {categoryData.icon === 'code' && (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              )}
              {categoryData.icon === 'palette' && (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
              )}
              {categoryData.icon === 'heart' && (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
              )}
              {categoryData.icon === 'lightbulb' && (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              )}
              {!categoryData.icon && (
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              )}
            </svg>
          )}
          {categoryData.name || category}
        </span>
      </a>
    )}
    
    <time datetime={pubDate.toISOString()} class="inline-flex items-center">
      <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      {formattedDate}
    </time>
    
    {updatedDate && (
      <span class="inline-flex items-center">
        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        更新于 {formatDate(updatedDate)}
      </span>
    )}
    
    <span class="inline-flex items-center">
      <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
      {formattedReadingTime}
    </span>
  </div>
  
  <!-- 标签 -->
  {tags && tags.length > 0 && (
    <div class="flex flex-wrap gap-2 mb-6">
      {tags.map((tag) => (
        <a
          href={`/tags/${encodeURIComponent(tag)}/`}
          class="px-3 py-1 text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full hover:bg-primary-100 dark:hover:bg-primary-900 hover:text-primary-700 dark:hover:text-primary-300 transition-colors"
        >
          #{tag}
        </a>
      ))}
    </div>
  )}
  
  <!-- 描述 -->
  {description && (
    <p class="text-lg text-gray-600 dark:text-gray-300 mb-6">
      {description}
    </p>
  )}
</header>

<!-- 文章内容 -->
<main class="prose prose-gray dark:prose-invert max-w-none">
  <div set:html={processedHtml} />
</main>

<!-- 文章底部 -->
<footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
  <!-- 分享按钮 -->
  <div class="flex items-center justify-between mb-6">
    <div class="text-sm text-gray-600 dark:text-gray-400">
      如果觉得这篇文章对你有帮助，欢迎分享给更多人
    </div>
    
    <div class="flex space-x-4">
      <!-- Twitter分享 -->
      <a
        href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(new URL(`/blog/${post.slug}/`, Astro.site).toString())}`}
        target="_blank"
        rel="noopener noreferrer"
        class="text-gray-500 hover:text-blue-500 transition-colors"
        aria-label="分享到Twitter"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
        </svg>
      </a>
      
      <!-- LinkedIn分享 -->
      <a
        href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(new URL(`/blog/${post.slug}/`, Astro.site).toString())}`}
        target="_blank"
        rel="noopener noreferrer"
        class="text-gray-500 hover:text-blue-700 transition-colors"
        aria-label="分享到LinkedIn"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
        </svg>
      </a>
      
      <!-- 复制链接 -->
      <button
        id="copy-link"
        class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors"
        aria-label="复制链接"
        data-url={new URL(`/blog/${post.slug}/`, Astro.site).toString()}
      >
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
      </button>
      <ReadingMode />
      <FontSizeAdjuster />
      <Bookmark />
    </div>
  </div>
  
  <!-- 上一篇/下一篇导航 -->
  <nav class="flex justify-between items-center">
    <div class="flex-1">
      {prev && (
        <a href={`/blog/${prev.slug}/`} class="inline-flex flex-col items-start text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors group">
          <span class="text-xs text-gray-500 dark:text-gray-500 mb-1">上一篇</span>
          <span class="flex items-center">
            <svg class="w-4 h-4 mr-1 transition-transform group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            {prev.data.title}
          </span>
        </a>
      )}
    </div>
    
    <div class="flex-1 text-right">
      {next && (
        <a href={`/blog/${next.slug}/`} class="inline-flex flex-col items-end text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors group">
          <span class="text-xs text-gray-500 dark:text-gray-500 mb-1">下一篇</span>
          <span class="flex items-center">
            {next.data.title}
            <svg class="w-4 h-4 ml-1 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </span>
        </a>
      )}
    </div>
  </nav>
</footer>

<!-- 评论区 -->
<Comments />

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 复制链接功能
    const copyButton = document.getElementById('copy-link');
    if (copyButton) {
      copyButton.addEventListener('click', () => {
        const url = copyButton.getAttribute('data-url');
        
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).then(() => {
            // 显示复制成功提示
            const originalHTML = copyButton.innerHTML;
            copyButton.innerHTML = `
              <svg class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            `;
            
            setTimeout(() => {
              copyButton.innerHTML = originalHTML;
            }, 2000);
          });
        }
      });
    }
  });
</script>

<style>
  .prose {
    font-size: 1.125rem;
    line-height: 1.75;
  }

  .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
  }

  .prose h1 {
    font-size: 2.25rem;
    line-height: 1.1;
  }

  .prose h2 {
    font-size: 1.875rem;
    line-height: 1.2;
  }

  .prose h3 {
    font-size: 1.5rem;
    line-height: 1.3;
  }

  .prose p {
    margin-top: 0;
    margin-bottom: 1.5rem;
  }

  .prose ul, .prose ol {
    margin-top: 0;
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }

  .prose li {
    margin-bottom: 0.5rem;
  }

  .prose a {
    color: #3b82f6;
    text-decoration: none;
    border-bottom: 1px dashed #3b82f6;
  }

  .prose a:hover {
    color: #2563eb;
    border-bottom-style: solid;
  }

  .prose img {
    border-radius: 0.5rem;
  }

  .prose blockquote {
    margin-top: 0;
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
    border-left: 4px solid #e5e7eb;
    color: #6b7280;
  }

  @media (prefers-color-scheme: dark) {
    .prose a {
      color: #60a5fa;
    }

    .prose a:hover {
      color: #93c5fd;
    }

    .prose blockquote {
      border-left-color: #4b5563;
      color: #9ca3af;
    }
  }

  @media (max-width: 768px) {
    .prose {
      font-size: 1rem;
    }

    .prose h1 {
      font-size: 1.875rem;
    }

    .prose h2 {
      font-size: 1.5rem;
    }

    .prose h3 {
      font-size: 1.25rem;
    }
  }

  .flex.space-x-4 a:hover,
  .flex.space-x-4 button:hover {
    transform: translateY(-2px);
    transition: transform 0.2s ease;
  }

  nav a {
    transition: all 0.2s ease;
  }

  .prose pre {
    border-radius: 0.5rem;
    overflow-x: auto;
  }

  .prose table {
    width: 100%;
    margin-top: 0;
    margin-bottom: 1.5rem;
    border-collapse: collapse;
  }

  .prose th, .prose td {
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
  }

  @media (prefers-color-scheme: dark) {
    .prose th, .prose td {
      border-color: #4b5563;
    }
  }
</style>