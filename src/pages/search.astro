---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { searchPosts } from '../utils/search';
import SearchBox from '../components/search/SearchBox.astro';
import SearchResults from '../components/search/SearchResults.astro';
import SearchFilters from '../components/search/SearchFilters.astro';

// 获取所有文章
const allPosts = await getCollection('blog');

// 获取搜索参数
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const category = url.searchParams.get('category') || '';
const tagsParam = url.searchParams.get('tags') || '';
const sortBy = (url.searchParams.get('sort') as 'relevance' | 'date' | 'title') || 'relevance';
const sortOrder = (url.searchParams.get('order') as 'asc' | 'desc') || 'desc';

// 解析标签
const tags = tagsParam ? tagsParam.split(',').filter(tag => tag.trim()) : [];

// 执行搜索
const searchResults = query 
  ? await searchPosts(allPosts, { query, category, tags, sortBy, sortOrder })
  : [];

// 获取所有可用的分类和标签
const categories = [...new Set(allPosts.map(post => post.data.category).filter(Boolean))];
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];
---

<Layout title={`搜索${query ? `: ${query}` : ''}`} description="搜索博客文章">
  <main class="container mx-auto px-4 py-8 max-w-5xl">
    <h1 class="text-3xl font-bold mb-8 text-center">搜索文章</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- 搜索框和过滤器 -->
      <div class="lg:col-span-1">
        <div class="sticky top-8 space-y-6">
          <SearchBox initialQuery={query} />
          
          <SearchFilters 
            categories={categories}
            allTags={allTags}
            initialCategory={category}
            initialTags={tags}
            initialSortBy={sortBy}
            initialSortOrder={sortOrder}
          />
        </div>
      </div>
      
      <!-- 搜索结果 -->
      <div class="lg:col-span-3">
        <SearchResults 
          results={searchResults}
          query={query}
          totalPosts={allPosts.length}
        />
      </div>
    </div>
  </main>
</Layout>

<style>
  /* 搜索结果高亮样式 */
  mark {
    background-color: var(--accent);
    color: var(--accent-contrast);
    padding: 0 2px;
    border-radius: 2px;
  }
  
  /* 响应式调整 */
  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }
  }
</style>