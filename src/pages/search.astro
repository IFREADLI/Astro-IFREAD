---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { searchPosts } from '../utils/search';
import SearchBox from '../components/search/SearchBox.astro';
import SearchResults from '../components/search/SearchResults.astro';
import SearchFilters from '../components/search/SearchFilters.astro';

// Get all posts
const allPosts = await getCollection('blog');

// Get search parameters
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const category = url.searchParams.get('category') || '';
const tagsParam = url.searchParams.get('tags') || '';
const sortBy = (url.searchParams.get('sort') as 'relevance' | 'date' | 'title') || 'relevance';
const sortOrder = (url.searchParams.get('order') as 'asc' | 'desc') || 'desc';

// Parse tags
const tags = tagsParam ? tagsParam.split(',').filter(tag => tag.trim()) : [];

// Execute search
const searchResults = query 
  ? await searchPosts(allPosts, { query, category, tags, sortBy, sortOrder })
  : [];

// Get all available categories and tags
const categories = [...new Set(allPosts.map(post => post.data.category).filter(Boolean))];
const allTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];
---

<Layout title={`Search${query ? `: ${query}` : ''}`} description="Search blog posts">
  <main class="container mx-auto px-4 py-8 max-w-5xl">
    <h1 class="text-3xl font-bold mb-8 text-center">Search Posts</h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <div class="lg:col-span-1">
        <div class="sticky top-8 space-y-6">
          <SearchBox initialQuery={query} />
          
          <SearchFilters 
            categories={categories}
            allTags={allTags}
            initialCategory={category}
            initialTags={tags}
            initialSortBy={sortBy}
            initialSortOrder={sortOrder}
          />
        </div>
      </div>
      
      <div class="lg:col-span-3">
        <SearchResults 
          results={searchResults}
          query={query}
          totalPosts={allPosts.length}
        />
      </div>
    </div>
  </main>
</Layout>