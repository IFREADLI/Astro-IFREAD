---
import Layout from '../../layouts/Layout.astro';
import PostContent from '../../components/blog/PostContent.astro';
import TableOfContents from '../../components/blog/TableOfContents.astro';
import ReadingProgress from '../../components/blog/ReadingProgress.astro';
import { getCollection } from 'astro:content';
import { getAdjacentPosts, extractHeadings } from '../../utils/content';
import type { CollectionEntry } from 'astro:content';

// 获取当前文章
export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => {
    return !data.draft;
  });
  
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// 获取所有文章用于上一篇/下一篇导航
const allPosts = await getCollection('blog', ({ data }) => {
  return !data.draft;
});

// 获取上一篇/下一篇文章
const { prev, next } = getAdjacentPosts(post, allPosts);

// 提取文章内容中的标题
const content = await post.render();
const headings = extractHeadings(content.html);

// 准备SEO数据
const seoData = {
  title: post.data.title,
  description: post.data.description,
  image: post.data.image,
  type: 'BlogPosting',
  keywords: post.data.tags,
  author: post.data.author,
  publishedTime: post.data.publishDate.toISOString(),
  modifiedTime: post.data.updatedDate?.toISOString() || post.data.publishDate.toISOString(),
  articleSection: post.data.category,
  tags: post.data.tags,
  noIndex: post.data.draft,
  structuredData: {
    wordCount: post.data.wordCount,
    readingTime: post.data.readingTime
  }
};
---

<Layout {...seoData}>
  <ReadingProgress />
  
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- 文章内容 -->
      <div class="lg:col-span-3">
        <PostContent post={post} />
      </div>
      
      <!-- 侧边栏 -->
      <aside class="lg:col-span-1">
        <!-- 目录 -->
        {headings.length > 0 && (
          <div class="sticky top-20">
            <TableOfContents headings={headings} />
          </div>
        )}
      </aside>
    </div>
  </main>
</Layout>